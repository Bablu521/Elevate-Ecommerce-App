#!/bin/sh
# ===== Pre-Push Hook =====
# This script replicates CI checks locally before allowing push

echo "ğŸš€ Running pre-push checks..."

# 1. Validate branch name
branch_name=$(git rev-parse --abbrev-ref HEAD)
pattern="^(feature|bugfix|hotfix|release)/ECOM-[0-9]+/.+"

echo "ğŸ” Checking branch name..."
if ! echo "$branch_name" | grep -Eq "$pattern"; then
  echo "âŒ Invalid branch name: $branch_name"
  echo "âœ… Must follow: feature/ECOM-123/desc  OR  bugfix/ECOM-456/desc"
  exit 1
fi
echo "âœ… Branch name valid!"

# 2. Install dependencies
echo "ğŸ“¦ Running flutter pub get..."
flutter pub get || { echo "âŒ pub get failed"; exit 1; }

# 3. Generate intl files
echo "ğŸŒ Generating intl files..."
flutter pub run intl_utils:generate || { echo "âŒ intl generation failed"; exit 1; }

# 4. Run code generation
echo "âš™ï¸ Running build_runner..."
flutter pub run build_runner build --delete-conflicting-outputs || { echo "âŒ build_runner failed"; exit 1; }

# 5. Format check
echo "ğŸ¨ Checking formatting..."
flutter format --set-exit-if-changed . || { echo "âŒ Code formatting failed"; exit 1; }

# 6. Static analysis
echo "ğŸ” Running flutter analyze..."
flutter analyze || { echo "âŒ Analyzer issues found"; exit 1; }

# 7. Run unit tests
echo "ğŸ§ª Running tests..."
flutter test --coverage || { echo "âŒ Tests failed"; exit 1; }

echo "âœ… All checks passed. Proceeding with push."
